name: CI Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Set default permissions to read-only for security
permissions:
  contents: read

jobs:
  build:
    name: Build with XC8 Compiler (Docker)
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build XC8 Docker image
      run: |
        echo "Building Docker image with XC8 compiler..."
        docker build -t xc8-pic-builder:latest .
        
    - name: Build firmware using Docker
      run: |
        echo "Building PIC16F886 firmware in Docker container..."
        docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project \
          xc8-pic-builder:latest \
          /bin/bash -c "./build.sh"
        
    - name: Verify build output
      run: |
        echo "Checking for generated .hex file..."
        if [ -f dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex ]; then
          echo "✓ Build successful!"
          echo "Firmware file: dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex"
          echo "File size: $(wc -c < dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex) bytes"
          ls -lh dist/XC8_PIC16F886/production/
        else
          echo "✗ ERROR: .hex file not found"
          exit 1
        fi
        
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pic16f886
        path: |
          dist/XC8_PIC16F886/production/*.hex
          dist/XC8_PIC16F886/production/*.elf
        retention-days: 30
        
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
    - name: Run cppcheck
      run: |
        echo "Running static analysis with cppcheck..."
        cppcheck --enable=all --inconclusive --std=c99 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --error-exitcode=1 \
          --template='{file}:{line}: {severity}: {message}' \
          *.c 2>&1 | tee cppcheck-report.txt
        
        # Check results
        if grep -qE "(error|warning)" cppcheck-report.txt; then
          echo ""
          echo "=== Static Analysis Issues Found ==="
          cat cppcheck-report.txt
          echo ""
          echo "✗ Code quality issues detected"
          echo "Please fix all errors and warnings before merging"
          exit 1
        else
          echo "✓ No static analysis issues found!"
        fi
        
    - name: Upload analysis report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-report
        path: cppcheck-report.txt
        retention-days: 30

  # Summary job that requires all checks to pass
  # This is the required status check for PR merging
  ci-success:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [build, static-analysis, test]
    if: always()
    
    permissions:
      contents: read
    
    steps:
    - name: Check all jobs status
      run: |
        echo "Checking status of all CI jobs..."
        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "✗ Build job failed"
          exit 1
        fi
        if [ "${{ needs.static-analysis.result }}" != "success" ]; then
          echo "✗ Static analysis job failed"
          exit 1
        fi
        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "✗ Test job failed"
          exit 1
        fi
        echo "✓ All CI checks passed!"
        echo ""
        echo "Summary:"
        echo "  - Build: ${{ needs.build.result }}"
        echo "  - Static Analysis: ${{ needs.static-analysis.result }}"
        echo "  - Tests: ${{ needs.test.result }}"

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install test dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make ruby
        # Install Ceedling (Ruby-based test framework for C)
        sudo gem install ceedling
        
    - name: Run tests
      run: |
        echo "Running unit tests..."
        ceedling test:all
        echo "✓ All tests passed!"
        
    - name: Verify test count
      run: |
        echo "Verifying minimum test coverage..."
        # Ensure we have at least 50 tests (current: 55)
        # This prevents accidental removal of tests
        
        # Extract test count from output
        TEST_OUTPUT=$(ceedling test:all 2>&1)
        TEST_COUNT=$(echo "$TEST_OUTPUT" | grep "TESTED:" | awk '{print $2}')
        
        echo "Current test count: $TEST_COUNT"
        
        MIN_TESTS=50
        if [ "$TEST_COUNT" -ge "$MIN_TESTS" ]; then
          echo "✓ Test count verification passed ($TEST_COUNT tests >= $MIN_TESTS minimum)"
        else
          echo "✗ ERROR: Test count below minimum threshold"
          echo "Current: $TEST_COUNT tests"
          echo "Required: $MIN_TESTS tests minimum"
          echo "Tests must be maintained or increased, not removed"
          exit 1
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/artifacts/test/
        retention-days: 30

name: CI Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Set default permissions to read-only for security
permissions:
  contents: read

jobs:
  build:
    name: Build with XC8 Compiler (Docker)
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build XC8 Docker image
      run: |
        echo "Building Docker image with XC8 compiler..."
        docker build -t xc8-pic-builder:latest .
        
    - name: Build firmware using Docker
      run: |
        echo "Building PIC16F886 firmware in Docker container..."
        docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project \
          xc8-pic-builder:latest \
          /bin/bash -c "./build.sh"
        
    - name: Verify build output
      run: |
        echo "Checking for generated .hex file..."
        if [ -f dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex ]; then
          echo "✓ Build successful!"
          echo "Firmware file: dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex"
          echo "File size: $(wc -c < dist/XC8_PIC16F886/production/PetSafe-CatFlap.production.hex) bytes"
          ls -lh dist/XC8_PIC16F886/production/
        else
          echo "✗ ERROR: .hex file not found"
          exit 1
        fi
        
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pic16f886
        path: |
          dist/XC8_PIC16F886/production/*.hex
          dist/XC8_PIC16F886/production/*.elf
        retention-days: 30
        
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --std=c99 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --template='{file}:{line}: {severity}: {message}' \
          --quiet \
          *.c 2> cppcheck-report.txt
        
    - name: Display cppcheck results
      if: always()
      run: |
        if [ -s cppcheck-report.txt ]; then
          echo "=== Cppcheck Analysis Results ==="
          cat cppcheck-report.txt
          # Don't fail on warnings, just display them
          echo "Analysis complete - review warnings above"
        else
          echo "No issues found by cppcheck"
        fi
        
    - name: Upload analysis report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-report
        path: cppcheck-report.txt
        retention-days: 30

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install test dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make ruby
        # Install Ceedling (Ruby-based test framework for C)
        sudo gem install ceedling
        
    - name: Run tests
      run: |
        if [ -d "test" ] && [ -f "project.yml" ]; then
          ceedling test:all
        else
          echo "Test infrastructure not yet set up - skipping tests"
          echo "Tests will be available after test suite is created"
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/artifacts/test/
        retention-days: 30
